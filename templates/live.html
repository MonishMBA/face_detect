<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Webcam Feed with Emotion Detection</title>
</head>
<body>
    <h1>Webcam Feed with Emotion Detection</h1>
    <video id="webcam" width="640" height="480" autoplay></video>

    <!-- Hidden canvas to capture frames from the video -->
    <canvas id="canvas" style="display: none;"></canvas>

    <script>
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('canvas');
        const canvasContext = canvasElement.getContext('2d');

        // Request webcam access
        navigator.mediaDevices.getUserMedia({ video: true })
            .then((stream) => {
                videoElement.srcObject = stream;
            })
            .catch((err) => {
                console.error('Error accessing webcam: ' + err);
            });

        // Function to send the frame to the server
        function sendFrameToServer() {
            // Draw the current video frame onto the canvas
            canvasContext.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

            // Convert the frame to a base64-encoded image
            const frameData = canvasElement.toDataURL('image/jpeg');

            // Send the frame to the server using Fetch API
            fetch('/process_frame', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ frame: frameData })
            })
            .then(response => response.json())
            .then(data => {
                // Display the emotion detected and update the video feed with the processed frame
                console.log('Emotion:', data.emotion);
                console.log('Time taken:', data.time_ms, 'ms');

                // Update the video element with the processed frame
                const processedImage = new Image();
                processedImage.src = data.frame;
                processedImage.onload = function() {
                    document.body.appendChild(processedImage);  // Optionally, you can replace the existing image here
                };
            })
            .catch(error => {
                console.error('Error sending frame to server:', error);
            });
        }

        // Call sendFrameToServer every 100ms to send frames periodically
        setInterval(sendFrameToServer, 100);
    </script>
</body>
</html>
